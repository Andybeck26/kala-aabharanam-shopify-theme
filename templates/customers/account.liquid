{% comment %}
  Customer Account Dashboard Template
  Provides comprehensive account management with order history and account details
{% endcomment %}

<div class="customer-account" x-data="customerAccount()">
  <div class="container">
    <!-- Page Header -->
    <div class="customer-account__header">
      <div class="customer-account__welcome">
        <h1 class="customer-account__title">
          Welcome back, {{ customer.first_name | default: 'Valued Customer' }}!
        </h1>
        <p class="customer-account__subtitle">
          Manage your account, track orders, and discover new treasures
        </p>
      </div>
      <div class="customer-account__actions">
        <a href="{{ routes.account_logout_url }}" class="btn btn--secondary">
          {% render 'icon', icon: 'logout' %}
          {{ 'customer.account.log_out' | t }}
        </a>
      </div>
    </div>

    <div class="customer-account__layout">
      <!-- Sidebar Navigation -->
      <nav class="customer-account__nav" aria-label="Account navigation">
        <ul class="account-nav">
          <li class="account-nav__item">
            <button 
              class="account-nav__link"
              :class="{ 'account-nav__link--active': activeTab === 'overview' }"
              @click="setActiveTab('overview')"
            >
              {% render 'icon', icon: 'dashboard' %}
              {{ 'customer.account.overview' | t }}
            </button>
          </li>
          <li class="account-nav__item">
            <button 
              class="account-nav__link"
              :class="{ 'account-nav__link--active': activeTab === 'orders' }"
              @click="setActiveTab('orders')"
            >
              {% render 'icon', icon: 'orders' %}
              {{ 'customer.orders.title' | t }}
              {% if customer.orders_count > 0 %}
                <span class="account-nav__badge">{{ customer.orders_count }}</span>
              {% endif %}
            </button>
          </li>
          <li class="account-nav__item">
            <button 
              class="account-nav__link"
              :class="{ 'account-nav__link--active': activeTab === 'addresses' }"
              @click="setActiveTab('addresses')"
            >
              {% render 'icon', icon: 'location' %}
              {{ 'customer.addresses.title' | t }}
            </button>
          </li>
          <li class="account-nav__item">
            <button 
              class="account-nav__link"
              :class="{ 'account-nav__link--active': activeTab === 'wishlist' }"
              @click="setActiveTab('wishlist')"
            >
              {% render 'icon', icon: 'heart' %}
              {{ 'customer.wishlist.title' | t }}
              <span class="account-nav__badge" x-text="wishlistCount" x-show="wishlistCount > 0"></span>
            </button>
          </li>
          <li class="account-nav__item">
            <button 
              class="account-nav__link"
              :class="{ 'account-nav__link--active': activeTab === 'profile' }"
              @click="setActiveTab('profile')"
            >
              {% render 'icon', icon: 'user' %}
              {{ 'customer.account.details' | t }}
            </button>
          </li>
        </ul>
      </nav>

      <!-- Main Content -->
      <main class="customer-account__main">
        <!-- Overview Tab -->
        <div class="account-tab" x-show="activeTab === 'overview'" x-transition>
          <div class="account-overview">
            <h2 class="account-section__title">Account Overview</h2>
            
            <!-- Quick Stats -->
            <div class="account-stats">
              <div class="account-stat">
                <div class="account-stat__icon">
                  {% render 'icon', icon: 'orders' %}
                </div>
                <div class="account-stat__content">
                  <div class="account-stat__number">{{ customer.orders_count }}</div>
                  <div class="account-stat__label">Total Orders</div>
                </div>
              </div>
              
              <div class="account-stat">
                <div class="account-stat__icon">
                  {% render 'icon', icon: 'heart' %}
                </div>
                <div class="account-stat__content">
                  <div class="account-stat__number" x-text="wishlistCount">0</div>
                  <div class="account-stat__label">Wishlist Items</div>
                </div>
              </div>
              
              <div class="account-stat">
                <div class="account-stat__icon">
                  {% render 'icon', icon: 'location' %}
                </div>
                <div class="account-stat__content">
                  <div class="account-stat__number">{{ customer.addresses_count }}</div>
                  <div class="account-stat__label">Saved Addresses</div>
                </div>
              </div>
            </div>

            <!-- Recent Orders -->
            {% if customer.orders.size > 0 %}
              <div class="account-section">
                <div class="account-section__header">
                  <h3 class="account-section__title">Recent Orders</h3>
                  <button 
                    class="btn btn--secondary btn--small"
                    @click="setActiveTab('orders')"
                  >
                    View All Orders
                  </button>
                </div>
                
                <div class="order-list">
                  {% for order in customer.orders limit: 3 %}
                    <div class="order-card">
                      <div class="order-card__header">
                        <div class="order-card__number">
                          <strong>{{ order.name }}</strong>
                        </div>
                        <div class="order-card__status order-card__status--{{ order.financial_status }}">
                          {{ order.financial_status | capitalize }}
                        </div>
                      </div>
                      
                      <div class="order-card__details">
                        <div class="order-card__date">
                          {{ order.created_at | date: '%B %d, %Y' }}
                        </div>
                        <div class="order-card__total">
                          {{ order.total_price | money }}
                        </div>
                      </div>
                      
                      <div class="order-card__actions">
                        <a href="{{ order.customer_url }}" class="btn btn--secondary btn--small">
                          View Details
                        </a>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% else %}
              <div class="account-section">
                <div class="empty-state">
                  <div class="empty-state__icon">
                    {% render 'icon', icon: 'orders' %}
                  </div>
                  <h3 class="empty-state__title">No Orders Yet</h3>
                  <p class="empty-state__message">
                    Start exploring our beautiful collection of jewellery and textiles
                  </p>
                  <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary">
                    Start Shopping
                  </a>
                </div>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Orders Tab -->
        <div class="account-tab" x-show="activeTab === 'orders'" x-transition>
          <div class="account-orders">
            <h2 class="account-section__title">Order History</h2>
            
            {% if customer.orders.size > 0 %}
              <div class="orders-filter">
                <select class="form-select" x-model="orderFilter" @change="filterOrders()">
                  <option value="all">All Orders</option>
                  <option value="pending">Pending</option>
                  <option value="paid">Paid</option>
                  <option value="shipped">Shipped</option>
                  <option value="delivered">Delivered</option>
                </select>
              </div>
              
              <div class="order-list order-list--detailed">
                {% for order in customer.orders %}
                  <div class="order-card order-card--detailed" data-status="{{ order.financial_status }}">
                    <div class="order-card__header">
                      <div class="order-card__info">
                        <div class="order-card__number">
                          <strong>Order {{ order.name }}</strong>
                        </div>
                        <div class="order-card__date">
                          Placed on {{ order.created_at | date: '%B %d, %Y at %I:%M %p' }}
                        </div>
                      </div>
                      <div class="order-card__status-group">
                        <div class="order-card__status order-card__status--{{ order.financial_status }}">
                          {{ order.financial_status | capitalize }}
                        </div>
                        {% if order.fulfillment_status %}
                          <div class="order-card__fulfillment order-card__fulfillment--{{ order.fulfillment_status }}">
                            {{ order.fulfillment_status | capitalize }}
                          </div>
                        {% endif %}
                      </div>
                    </div>
                    
                    <div class="order-card__items">
                      {% for line_item in order.line_items limit: 3 %}
                        <div class="order-item">
                          <div class="order-item__image">
                            {% if line_item.image %}
                              <img 
                                src="{{ line_item.image | image_url: width: 80 }}" 
                                alt="{{ line_item.title }}"
                                loading="lazy"
                              >
                            {% else %}
                              <div class="order-item__placeholder">
                                {% render 'icon', icon: 'placeholder' %}
                              </div>
                            {% endif %}
                          </div>
                          <div class="order-item__details">
                            <div class="order-item__title">{{ line_item.title }}</div>
                            {% if line_item.variant_title and line_item.variant_title != 'Default Title' %}
                              <div class="order-item__variant">{{ line_item.variant_title }}</div>
                            {% endif %}
                            <div class="order-item__quantity">Qty: {{ line_item.quantity }}</div>
                          </div>
                          <div class="order-item__price">
                            {{ line_item.final_price | money }}
                          </div>
                        </div>
                      {% endfor %}
                      
                      {% if order.line_items.size > 3 %}
                        <div class="order-card__more-items">
                          +{{ order.line_items.size | minus: 3 }} more items
                        </div>
                      {% endif %}
                    </div>
                    
                    <div class="order-card__footer">
                      <div class="order-card__total">
                        <strong>Total: {{ order.total_price | money }}</strong>
                      </div>
                      <div class="order-card__actions">
                        <a href="{{ order.customer_url }}" class="btn btn--secondary btn--small">
                          View Details
                        </a>
                        {% if order.financial_status == 'paid' and order.fulfillment_status != 'fulfilled' %}
                          <button class="btn btn--secondary btn--small" @click="trackOrder('{{ order.name }}')">
                            Track Order
                          </button>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <div class="empty-state__icon">
                  {% render 'icon', icon: 'orders' %}
                </div>
                <h3 class="empty-state__title">No Orders Found</h3>
                <p class="empty-state__message">
                  You haven't placed any orders yet. Discover our exquisite collection!
                </p>
                <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary">
                  Start Shopping
                </a>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Addresses Tab -->
        <div class="account-tab" x-show="activeTab === 'addresses'" x-transition>
          <div class="account-addresses">
            <div class="account-section__header">
              <h2 class="account-section__title">Saved Addresses</h2>
              <a href="{{ routes.account_addresses_url }}" class="btn btn--primary">
                {% render 'icon', icon: 'plus' %}
                Add New Address
              </a>
            </div>
            
            {% if customer.addresses.size > 0 %}
              <div class="address-grid">
                {% for address in customer.addresses %}
                  <div class="address-card">
                    {% if address == customer.default_address %}
                      <div class="address-card__badge">Default</div>
                    {% endif %}
                    
                    <div class="address-card__content">
                      <div class="address-card__name">
                        {{ address.first_name }} {{ address.last_name }}
                      </div>
                      <div class="address-card__address">
                        {{ address.address1 }}
                        {% if address.address2 != blank %}
                          <br>{{ address.address2 }}
                        {% endif %}
                        <br>{{ address.city }}, {{ address.province }} {{ address.zip }}
                        <br>{{ address.country }}
                      </div>
                      {% if address.phone != blank %}
                        <div class="address-card__phone">
                          {{ address.phone }}
                        </div>
                      {% endif %}
                    </div>
                    
                    <div class="address-card__actions">
                      <a href="{{ routes.account_addresses_url }}/{{ address.id }}" class="btn btn--secondary btn--small">
                        Edit
                      </a>
                      {% unless address == customer.default_address %}
                        <button class="btn btn--secondary btn--small" @click="deleteAddress({{ address.id }})">
                          Delete
                        </button>
                      {% endunless %}
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="empty-state">
                <div class="empty-state__icon">
                  {% render 'icon', icon: 'location' %}
                </div>
                <h3 class="empty-state__title">No Addresses Saved</h3>
                <p class="empty-state__message">
                  Add your addresses for faster checkout
                </p>
                <a href="{{ routes.account_addresses_url }}" class="btn btn--primary">
                  Add Address
                </a>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Wishlist Tab -->
        <div class="account-tab" x-show="activeTab === 'wishlist'" x-transition>
          <div class="account-wishlist">
            <h2 class="account-section__title">My Wishlist</h2>
            
            <div class="wishlist-grid" x-show="wishlistItems.length > 0">
              <template x-for="item in wishlistItems" :key="item.id">
                <div class="wishlist-item">
                  <div class="wishlist-item__image">
                    <img :src="item.image" :alt="item.title" loading="lazy">
                  </div>
                  <div class="wishlist-item__content">
                    <h3 class="wishlist-item__title" x-text="item.title"></h3>
                    <div class="wishlist-item__price" x-text="item.price"></div>
                    <div class="wishlist-item__actions">
                      <button class="btn btn--primary btn--small" @click="addToCart(item)">
                        Add to Cart
                      </button>
                      <button class="btn btn--secondary btn--small" @click="removeFromWishlist(item.id)">
                        Remove
                      </button>
                    </div>
                  </div>
                </div>
              </template>
            </div>
            
            <div class="empty-state" x-show="wishlistItems.length === 0">
              <div class="empty-state__icon">
                {% render 'icon', icon: 'heart' %}
              </div>
              <h3 class="empty-state__title">Your Wishlist is Empty</h3>
              <p class="empty-state__message">
                Save items you love for later by clicking the heart icon
              </p>
              <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary">
                Discover Products
              </a>
            </div>
          </div>
        </div>

        <!-- Profile Tab -->
        <div class="account-tab" x-show="activeTab === 'profile'" x-transition>
          <div class="account-profile">
            <h2 class="account-section__title">Account Details</h2>
            
            {% form 'customer', class: 'customer-form' %}
              {% if form.errors %}
                <div class="form-errors" role="alert">
                  <h3 class="form-errors__title">Please correct the following:</h3>
                  <ul class="form-errors__list">
                    {% for error in form.errors %}
                      <li>{{ error | first | capitalize }} {{ error | last }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

              <div class="form-row">
                <div class="form-field">
                  <label for="customer-first-name" class="form-label">
                    {{ 'customer.register.first_name' | t }}
                  </label>
                  <input
                    type="text"
                    id="customer-first-name"
                    name="customer[first_name]"
                    class="form-input"
                    value="{{ customer.first_name }}"
                    required
                  >
                </div>

                <div class="form-field">
                  <label for="customer-last-name" class="form-label">
                    {{ 'customer.register.last_name' | t }}
                  </label>
                  <input
                    type="text"
                    id="customer-last-name"
                    name="customer[last_name]"
                    class="form-input"
                    value="{{ customer.last_name }}"
                    required
                  >
                </div>
              </div>

              <div class="form-field">
                <label for="customer-email" class="form-label">
                  {{ 'customer.register.email' | t }}
                </label>
                <input
                  type="email"
                  id="customer-email"
                  name="customer[email]"
                  class="form-input"
                  value="{{ customer.email }}"
                  required
                >
              </div>

              <div class="form-field form-field--checkbox">
                <label class="checkbox-label">
                  <input
                    type="checkbox"
                    name="customer[accepts_marketing]"
                    class="checkbox-input"
                    {% if customer.accepts_marketing %}checked{% endif %}
                  >
                  <span class="checkbox-checkmark"></span>
                  <span class="checkbox-text">
                    {{ 'customer.register.marketing_consent' | t }}
                  </span>
                </label>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn btn--primary">
                  {{ 'customer.account.save' | t }}
                </button>
              </div>
            {% endform %}
          </div>
        </div>
      </main>
    </div>
  </div>
</div>

<script>
  function customerAccount() {
    return {
      activeTab: 'overview',
      orderFilter: 'all',
      wishlistItems: [],
      wishlistCount: 0,

      setActiveTab(tab) {
        this.activeTab = tab;
        
        // Update URL hash
        window.history.replaceState({}, '', `#${tab}`);
        
        // Track analytics
        if (window.KalaAabharanam?.Analytics) {
          window.KalaAabharanam.Analytics.trackPageView(`Account - ${tab}`, window.location.href);
        }
      },

      filterOrders() {
        const orders = document.querySelectorAll('[data-status]');
        orders.forEach(order => {
          const status = order.dataset.status;
          if (this.orderFilter === 'all' || status === this.orderFilter) {
            order.style.display = 'block';
          } else {
            order.style.display = 'none';
          }
        });
      },

      trackOrder(orderNumber) {
        // Implement order tracking functionality
        window.KalaAabharanam.showNotification(`Tracking information for order ${orderNumber} will be sent to your email`, 'info');
      },

      deleteAddress(addressId) {
        if (confirm('Are you sure you want to delete this address?')) {
          // Implement address deletion
          window.location.href = `/account/addresses/${addressId}`;
        }
      },

      loadWishlist() {
        // Load wishlist from localStorage
        try {
          const saved = localStorage.getItem('kala_wishlist');
          this.wishlistItems = saved ? JSON.parse(saved) : [];
          this.wishlistCount = this.wishlistItems.length;
        } catch (error) {
          console.error('Error loading wishlist:', error);
          this.wishlistItems = [];
          this.wishlistCount = 0;
        }
      },

      addToCart(item) {
        // Add wishlist item to cart
        if (Alpine.store('cart')) {
          Alpine.store('cart').addItem(item.variantId, 1);
        }
      },

      removeFromWishlist(itemId) {
        this.wishlistItems = this.wishlistItems.filter(item => item.id !== itemId);
        this.wishlistCount = this.wishlistItems.length;
        
        // Save to localStorage
        try {
          localStorage.setItem('kala_wishlist', JSON.stringify(this.wishlistItems));
        } catch (error) {
          console.error('Error saving wishlist:', error);
        }
        
        window.KalaAabharanam.showNotification('Item removed from wishlist', 'success');
      },

      init() {
        // Set active tab from URL hash
        const hash = window.location.hash.slice(1);
        if (['overview', 'orders', 'addresses', 'wishlist', 'profile'].includes(hash)) {
          this.activeTab = hash;
        }

        // Load wishlist
        this.loadWishlist();

        // Track page view
        if (window.KalaAabharanam?.Analytics) {
          window.KalaAabharanam.Analytics.trackPageView('Customer Account', window.location.href);
        }
      }
    }
  }
</script>

{% schema %}
{
  "name": "Customer Account",
  "settings": [
    {
      "type": "header",
      "content": "Account Dashboard Settings"
    },
    {
      "type": "checkbox",
      "id": "show_order_tracking",
      "label": "Show order tracking buttons",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_wishlist",
      "label": "Enable wishlist functionality",
      "default": true
    }
  ]
}
{% endschema %}