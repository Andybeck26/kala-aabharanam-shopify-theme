{% comment %}
  Collection template for displaying product listings
  Implements responsive grid layout with filtering and sorting
  Optimized for Core Web Vitals performance
{% endcomment %}

{% render 'critical-css' %}

<!-- Preload critical resources -->
<link rel="preload" href="{{ 'application.css' | asset_url }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="{{ 'application.css' | asset_url }}"></noscript>

<!-- Preload first few product images -->
{% for product in collection.products limit: 4 %}
  {% if product.featured_image %}
    <link rel="preload" as="image" href="{{ product.featured_image | image_url: width: 300 }}">
  {% endif %}
{% endfor %}

<div class="collection-page" x-data="collectionPage()">
  <!-- Collection Header -->
  <div class="collection-header">
    <div class="container">
      <!-- Breadcrumb Navigation -->
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <ol class="breadcrumb__list">
          <li class="breadcrumb__item">
            <a href="{{ routes.root_url }}" class="breadcrumb__link">Home</a>
          </li>
          <li class="breadcrumb__item">
            <span class="breadcrumb__current" aria-current="page">{{ collection.title }}</span>
          </li>
        </ol>
      </nav>

      <!-- Collection Title and Description -->
      <div class="collection-hero">
        <h1 class="collection-title">{{ collection.title }}</h1>
        {% if collection.description != blank %}
          <div class="collection-description">
            {{ collection.description }}
          </div>
        {% endif %}
      </div>

      <!-- Collection Stats and Sorting -->
      <div class="collection-toolbar">
        <div class="collection-results">
          <span class="results-count">
            {{ collection.products_count }} 
            {% if collection.products_count == 1 %}product{% else %}products{% endif %}
          </span>
        </div>

        <div class="collection-sort">
          <label for="sort-by" class="sort-label">Sort by:</label>
          <select id="sort-by" class="sort-select" @change="updateSort($event.target.value)">
            <option value="manual">Featured</option>
            <option value="best-selling">Best Selling</option>
            <option value="title-ascending">A-Z</option>
            <option value="title-descending">Z-A</option>
            <option value="price-ascending">Price: Low to High</option>
            <option value="price-descending">Price: High to Low</option>
            <option value="created-descending">Newest</option>
            <option value="created-ascending">Oldest</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Collection Content -->
  <div class="collection-content">
    <div class="container">
      <div class="collection-layout">
        <!-- Filter Sidebar (will be implemented in task 3.2) -->
        <aside class="collection-filters" id="collection-filters">
          <div class="filters-placeholder">
            <!-- Filters will be added in task 3.2 -->
          </div>
        </aside>

        <!-- Product Grid -->
        <main class="collection-main">
          {% if collection.products.size > 0 %}
            <div class="product-grid" id="product-grid">
              {% for product in collection.products %}
                {% render 'product-card', product: product, collection: collection %}
              {% endfor %}
            </div>

            <!-- Pagination -->
            {% if paginate.pages > 1 %}
              <nav class="pagination" aria-label="Pagination">
                <div class="pagination__container">
                  {% if paginate.previous %}
                    <a href="{{ paginate.previous.url }}" class="pagination__link pagination__prev">
                      {% render 'icon', icon: 'arrow-left' %}
                      Previous
                    </a>
                  {% endif %}

                  <div class="pagination__pages">
                    {% for part in paginate.parts %}
                      {% if part.is_link %}
                        <a href="{{ part.url }}" class="pagination__link">{{ part.title }}</a>
                      {% else %}
                        {% if part.title == paginate.current_page %}
                          <span class="pagination__current" aria-current="page">{{ part.title }}</span>
                        {% else %}
                          <span class="pagination__ellipsis">{{ part.title }}</span>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </div>

                  {% if paginate.next %}
                    <a href="{{ paginate.next.url }}" class="pagination__link pagination__next">
                      Next
                      {% render 'icon', icon: 'arrow-right' %}
                    </a>
                  {% endif %}
                </div>
              </nav>
            {% endif %}
          {% else %}
            <!-- Empty State -->
            <div class="collection-empty">
              <div class="empty-state">
                <h2 class="empty-state__title">No products found</h2>
                <p class="empty-state__message">
                  We couldn't find any products in this collection. 
                  Try browsing our other collections or use the search function.
                </p>
                <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary">
                  Browse All Products
                </a>
              </div>
            </div>
          {% endif %}
        </main>
      </div>
    </div>
  </div>
</div>

<script>
  function collectionPage() {
    return {
      currentSort: '{{ collection.sort_by | default: 'manual' }}',
      
      updateSort(sortValue) {
        this.currentSort = sortValue;
        const url = new URL(window.location);
        url.searchParams.set('sort_by', sortValue);
        window.location.href = url.toString();
      }
    }
  }
</script>

{% paginate collection.products by 24 %}
{% endpaginate %}
<!-- P
erformance monitoring -->
{% render 'performance-monitor' %}